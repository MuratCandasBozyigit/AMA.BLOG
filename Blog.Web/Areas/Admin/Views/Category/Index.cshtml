@using System.Security.Claims
@{
    ViewData["Title"] = "Admin Kategori Yönetimi";
}

<h2>Kategoriler</h2>

<div class="modal fade" id="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <input type="hidden" id="categoryId" />
            <div class="modal-body">
                <div class="mb-3">
                    <label for="name" class="form-label">Kategori Adı:</label>
                    <input type="text" id="name" placeholder="Lütfen Kategori Adı giriniz" class="form-control" required />
                    <span id="name-error" class="text-danger" style="display:none;">Alan boş bırakılamaz.</span>
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Açıklama:</label>
                    <textarea id="description" placeholder="Lütfen Açıklama giriniz" class="form-control" required></textarea>
                    <span id="description-error" class="text-danger" style="display:none;">Alan boş bırakılamaz.</span>
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">Etiketler:</label>
                    <select id="tags" multiple class="form-control">
                        <!-- Etiketler burada yüklenecek -->
                    </select>
                    <span id="tags-error" class="text-danger" style="display:none;">En az bir etiket seçilmelidir.</span>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" id="btnSave" class="btn btn-primary">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<div class="card bg-light text-dark">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><box-icon name="category" color="dark" size="sm" animation="tada"></box-icon> Kategorilerim</h5>
        <button id="btnAdd" class="btn btn-outline-primary">+ Yeni Kategori Ekle</button>
    </div>
    <div class="card-body">
        <table id="tblCategories" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Kategori Adı</th>
                    <th>Açıklama</th>
                    <th>Slug</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                <!-- Kategoriler burada yüklenecek -->
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // ...

            // Kategorileri ve etiketleri yükle
            function loadTags() {
                $.ajax({
                    url: '/Admin/Tag/GetAllTags', // Etiketleri yükleyeceğiniz URL
                    success: function (tags) {
                        tags.forEach(function (tag) {
                            $('#tags').append(new Option(tag.name, tag.id));
                        });
                    },
                    error: function () {
                        Swal.fire('Hata', 'Etiketler yüklenirken bir sorun oluştu.', 'error');
                    }
                });
            }

            // Sayfa yüklendiğinde etiketleri yükle
            loadTags();

            // Kategori kaydetme
            $('#btnSave').click(function () {
                var category = {
                    id: $('#categoryId').val(),
                    name: $('#name').val(),
                    description: $('#description').val(),
                    tags: $('#tags').val() // Seçilen etiketler
                };

                var url = $('#btnSave').text() === 'Ekle' ? '/Admin/Category/Add' : '/Admin/Category/Update/' + category.id;
                var method = $('#btnSave').text() === 'Ekle' ? 'POST' : 'PUT';

                $.ajax({
                    type: method,
                    url: url,
                    data: JSON.stringify(category),
                    contentType: 'application/json',
                    success: function () {
                        $('#modal').modal('hide');
                        table.ajax.reload();
                        Swal.fire('Başarılı', 'Kategori başarıyla ' + ($('#btnSave').text() === 'Ekle' ? 'eklendi' : 'güncellendi'), 'success');
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            var errors = xhr.responseJSON;
                            for (var key in errors) {
                                $("#" + key + "-error").text(errors[key]).show();
                            }
                        } else {
                            Swal.fire('Hata', 'Kategori işlemi sırasında bir sorun oluştu.', 'error');
                        }
                    }
                });
            });
        });

    </script>
}
